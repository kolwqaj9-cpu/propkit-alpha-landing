<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropKit AI | Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #0b0f1a;
            color: #e5e7eb;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="text-center">
        <div id="status-msg" class="text-xs uppercase tracking-[0.3em] text-gray-500 mb-6">Realtime Intent Monitor</div>
        <div id="total-count" class="text-[96px] md:text-[140px] font-extrabold leading-none">--</div>
        <div id="success-msg" class="mt-6 text-lg text-gray-400 hidden">验证成功：市场需求已确认</div>
    </div>

    <script>
        const S_URL = "https://vlrdiajxxnangawfcgvk.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZscmRpYWp4eG5hbmdhd2ZjZ3ZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTkxNzYyNiwiZXhwIjoyMDg1NDkzNjI2fQ.WJGxW0o_NFa9lgu_tJ1otsxjxI8-3O6RPIkjLMFRYEg";

        const totalEl = document.getElementById('total-count');
        const successEl = document.getElementById('success-msg');

        function setCount(value) {
            totalEl.innerText = Number.isFinite(value) ? value.toLocaleString() : '--';
            if (value >= 20) {
                totalEl.classList.add('text-green-400');
                successEl.classList.remove('hidden');
            } else {
                totalEl.classList.remove('text-green-400');
                successEl.classList.add('hidden');
            }
        }

        async function fetchTotal() {
            try {
                // 使用 GET 请求并设置 Prefer: count=exact 来获取总数
                const res = await fetch(`${S_URL}/rest/v1/purchase_intents?select=id`, {
                    method: "GET",
                    headers: {
                        "apikey": S_KEY,
                        "Authorization": "Bearer " + S_KEY,
                        "Prefer": "count=exact",
                        "Range": "0-0"
                    }
                });

                if (res.ok) {
                    // 尝试从 content-range header 获取总数
                    const range = res.headers.get('content-range');
                    if (range && range.includes('/')) {
                        const total = parseInt(range.split('/')[1], 10);
                        if (!Number.isNaN(total) && total >= 0) {
                            setCount(total);
                            return;
                        }
                    }
                    
                    // 如果 header 没有，尝试解析响应体
                    try {
                        const data = await res.json();
                        if (Array.isArray(data)) {
                            // 如果返回数组，说明表存在，但可能需要获取全部记录来计数
                            // 为了性能，我们只在第一次或失败时尝试
                            const fullRes = await fetch(`${S_URL}/rest/v1/purchase_intents?select=id`, {
                                headers: {
                                    "apikey": S_KEY,
                                    "Authorization": "Bearer " + S_KEY
                                }
                            });
                            if (fullRes.ok) {
                                const fullData = await fullRes.json();
                                if (Array.isArray(fullData)) {
                                    setCount(fullData.length);
                                    return;
                                }
                            }
                        }
                    } catch (jsonErr) {
                        console.warn("JSON parse error:", jsonErr);
                    }
                } else if (res.status === 404) {
                    // 表不存在，显示 0
                    console.warn("Table 'purchase_intents' not found. Showing 0.");
                    setCount(0);
                    return;
                }

                // 其他错误，显示 0
                console.warn("Failed to fetch count. Status:", res.status);
                setCount(0);
            } catch (e) {
                console.error("Fetch error:", e);
                setCount(0);
            }
        }

        fetchTotal();
        setInterval(fetchTotal, 5000);
    </script>
</body>
</html>
