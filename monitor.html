<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropKit AI | Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #0b0f1a;
            color: #e5e7eb;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="text-center">
        <div id="status-msg" class="text-xs uppercase tracking-[0.3em] text-gray-500 mb-6">Realtime Intent Monitor</div>
        <div id="total-count" class="text-[96px] md:text-[140px] font-extrabold leading-none">--</div>
        <div id="success-msg" class="mt-6 text-lg text-gray-400 hidden">验证成功：市场需求已确认</div>
    </div>

    <script>
        const S_URL = "https://vlrdiajxxnangawfcgvk.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZscmRpYWp4eG5hbmdhd2ZjZ3ZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTkxNzYyNiwiZXhwIjoyMDg1NDkzNjI2fQ.WJGxW0o_NFa9lgu_tJ1otsxjxI8-3O6RPIkjLMFRYEg";

        const totalEl = document.getElementById('total-count');
        const successEl = document.getElementById('success-msg');

        function setCount(value) {
            // 确保 value 是数字，默认 0
            const num = (typeof value === 'number' && Number.isFinite(value)) ? value : 0;
            totalEl.innerText = num.toLocaleString();
            if (num >= 20) {
                totalEl.classList.add('text-green-400');
                totalEl.classList.remove('text-gray-300');
                successEl.classList.remove('hidden');
            } else {
                totalEl.classList.remove('text-green-400');
                totalEl.classList.add('text-gray-300');
                successEl.classList.add('hidden');
            }
        }
        
        // 初始化显示 0
        setCount(0);

        async function fetchTotal() {
            try {
                // 强制使用 RPC 函数作为唯一数据源，废弃直接查询 purchase_intents 表
                const rpcRes = await fetch(`${S_URL}/rest/v1/rpc/get_purchase_intents_count`, {
                    method: "POST",
                    headers: {
                        "apikey": S_KEY,
                        "Authorization": "Bearer " + S_KEY,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                });
                
                if (rpcRes.ok) {
                    const count = await rpcRes.json();
                    if (typeof count === 'number' && count >= 0) {
                        setCount(count);
                        return;
                    } else {
                        console.warn("RPC returned invalid data:", count);
                        setCount(0);
                        return;
                    }
                } else {
                    console.error("RPC function failed:", rpcRes.status, await rpcRes.text());
                    setCount(0);
                    return;
                }
            } catch (e) {
                console.error("Fetch error:", e);
                setCount(0);
            }
        }

        fetchTotal();
        setInterval(fetchTotal, 5000);
    </script>
</body>
</html>
