<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropKit AI | Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: #0b0f1a;
            color: #e5e7eb;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="text-center">
        <div id="status-msg" class="text-xs uppercase tracking-[0.3em] text-gray-500 mb-6">Realtime Intent Monitor</div>
        <div id="total-count" class="text-[96px] md:text-[140px] font-extrabold leading-none">--</div>
        <div id="success-msg" class="mt-6 text-lg text-gray-400 hidden">验证成功：市场需求已确认</div>
    </div>

    <script>
        // 初始化 Supabase 客户端
        const S_URL = "https://vlrdiajxxnangawfcgvk.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZscmRpYWp4eG5hbmdhd2ZjZ3ZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTkxNzYyNiwiZXhwIjoyMDg1NDkzNjI2fQ.WJGxW0o_NFa9lgu_tJ1otsxjxI8-3O6RPIkjLMFRYEg";
        
        const { createClient } = supabase;
        const supabaseClient = createClient(S_URL, S_KEY);

        const totalEl = document.getElementById('total-count');
        const successEl = document.getElementById('success-msg');

        function setCount(value) {
            // 确保 value 是数字，默认 0
            const num = (typeof value === 'number' && Number.isFinite(value)) ? value : 0;
            totalEl.innerText = num.toLocaleString();
            if (num >= 20) {
                totalEl.classList.add('text-green-400');
                totalEl.classList.remove('text-gray-300');
                successEl.classList.remove('hidden');
            } else {
                totalEl.classList.remove('text-green-400');
                totalEl.classList.add('text-gray-300');
                successEl.classList.add('hidden');
            }
        }
        
        // 初始化显示 0
        setCount(0);

        // 彻底重写：强制使用 RPC 函数，禁止直接查询 purchase_intents 表
        async function fetchTotal() {
            try {
                const { data, error } = await supabaseClient.rpc('get_purchase_intents_count');
                
                if (error) {
                    console.error('RPC Error:', error);
                    setCount(0);
                    return;
                }
                
                // data 应该是数字（数据库中的 COUNT(*) 结果）
                if (typeof data === 'number' && data >= 0) {
                    setCount(data);
                } else {
                    console.warn('RPC returned invalid data:', data);
                    setCount(0);
                }
            } catch (e) {
                console.error('Fetch error:', e);
                setCount(0);
            }
        }

        // 立即执行一次，然后每 5 秒刷新
        fetchTotal();
        setInterval(fetchTotal, 5000);
    </script>
</body>
</html>
